apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig

metadata:
  name: marina
  region: ap-northeast-2

# Enable EKS Auto Mode
autoModeConfig:
  enabled: true

# Capabilities configuration
capabilities:
  # AWS Controllers for Kubernetes (ACK) - with existing role
  - name: ack-capability
    type: ACK
    # roleArn: arn:aws:iam::123456789012:role/ACK-S3-Controller-Role #optional, eksctl will create the role
    deletePropagationPolicy: RETAIN
    attachPolicyARNs:
      - arn:aws:iam::aws:policy/AdministratorAccess
    accessPolicies: # Attached after AE is created by Marina 
      - policyARN: arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy
        accessScope:
          type: cluster
    tags:
      Environment: dev
      Team: platform

  # Kubernetes Resource Optimizer (KRO) - with auto-created role
  - name: kro-optimizer
    type: KRO
    deletePropagationPolicy: RETAIN
    # attachPolicy:
    #   Version: '2012-10-17'
    #   Statement:
    #     - Effect: Allow
    #       Action:
    #         - eks:DescribeCluster
    #       Resource: '*'
    accessPolicies:
      - policyARN: arn:aws:eks::aws:cluster-access-policy/AmazonEKSEditPolicy
        accessScope:
          type: cluster
      - policyARN: arn:aws:eks::aws:cluster-access-policy/AmazonEKSViewPolicy
        accessScope:
          type: namespace
          namespaces:
            - kube-system
            - default
    tags:
      Environment: production
      Team: platform

  # ArgoCD GitOps
  - name: argocd-gitops
    type: ARGOCD
    # roleArn: arn:aws:iam::123456789012:role/ArgoCD-Role
    deletePropagationPolicy: RETAIN
    attachPolicyARNs:
      - arn:aws:iam::aws:policy/AdministratorAccess
    accessPolicies:
      - policyARN: arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy
        accessScope:
          type: cluster
    configuration:
      argocd:
        namespace: argocd
        awsIdc:
          idcInstanceArn: arn:aws:sso:::instance/ssoins-790784addf31db44
          idcRegion: us-west-2
        # networkAccess: # Need the VPC endpoint to be pre-povisioned
        #   vpceIds:
        #     - vpce-1234567890abcdef0
        rbacRoleMappings:
          - role: ADMIN
            identities:
              - id: 38414300-1041-708a-01af-5422d6091e34 # IDC USER ID
                type: SSO_USER
          - role: ADMIN
            identities:
              - id: 08017340-8041-7093-3ffa-debe3fc940cd # IDC GROUP ID
                type: SSO_GROUP
    tags:
      Environment: production
      Team: platform
name: Update generated files

on:
  workflow_dispatch: {}
  schedule:
  - cron: "0 5 * * Thu"

permissions:
  id-token: write

env:
  DEFAULT_BRANCH: main

jobs:
  update_generated_file:
    strategy:
      fail-fast: false
      matrix:
        resource: ["coredns", "aws-node", "nvidia-device-plugin"]
    name: Update ${{ matrix.resource }} and open PR
    runs-on: ubuntu-latest
    env:
      GOPRIVATE: ""
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 #v4.2.2
      with:
        fetch-depth: 0

    - name: Setup build environment
      uses: ./.github/actions/setup-build

    - name: Configure AWS credentials for coredns update
      if: ${{ matrix.resource == 'coredns' }}
      uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
      with:
        aws-region: us-west-2
        role-duration-seconds: 900
        role-session-name: eksctl-update-coredns-assets
        role-to-assume: ${{ secrets.UPDATE_COREDNS_ROLE_ARN }}

    - name: Setup identity as eksctl-bot
      uses: ./.github/actions/setup-identity
      with:
        token: "${{ secrets.EKSCTLBOT_TOKEN }}"

    - name: Update ${{ matrix.resource }}
      run: make update-${{ matrix.resource }}

    - name: Upsert pull request
      uses: peter-evans/create-pull-request@67ccf781d68cd99b580ae25a5c18a1cc84ffff1f #v7.0.6
      with:
        token: ${{ secrets.EKSCTLBOT_TOKEN }}
        commit-message: update ${{ matrix.resource }}${{ env.LATEST_RELEASE_TAG }}
        committer: eksctl-bot <eksctl-bot@users.noreply.github.com>
        title: 'Update ${{ matrix.resource }}${{ env.LATEST_RELEASE_TAG }}'
        branch: update-${{ matrix.resource }}
        labels: area/tech-debt
        body: |
          Auto-generated by [eksctl Update Generated Files GitHub workflow][1]

          [1]: https://github.com/eksctl-io/eksctl/blob/main/.github/workflows/update-generated.yaml

          Please manually test before approving and merging.

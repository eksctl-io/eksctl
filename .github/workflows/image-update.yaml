name: Image Update Workflow
on: [push]
#  push:
#    branches: [master]

jobs:
  # This has to be done in one job, as images are not shared between jobs, so any gain in performance will get compromised by having to pull the images again
  image-update:
    name: Build and Push All Image
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v1
      # Always make build image, it won't take long whenever there are no changes
      - run: make -f Makefile.docker build-image
      # Login to both registries
      - run: echo ${DOCKER_HUB_PASSWORD} | docker login --username weaveworkseksctlci --password-stdin
        env:
          DOCKER_HUB_PASSWORD: ${{ secrets.DOCKER_HUB_PASSWORD }}
      - run: |
          set -o errexit
          set -o pipefail
          set -o nounset

          # Update image manifest and push new image to registry only when needed
          if ! make -f Makefile.docker check-build-image-manifest-up-to-date ; then
            # First push updated image
            make -f Makefile.docker push-build-image
            # Now update the manifest and push new commits to master
            git config --local user.email "weaveworksbot@users.noreply.github.com"
            git config --local user.name "Weaveworks Bot"
            make -f Makefile.docker update-build-image-manifest
            git push
          fi

      - run: echo ${{ secrets.GITHUB_TOKEN }} | docker login docker.pkg.github.com --username ${{ github.actor }} --password-stdin
      - run: make -f Makefile.docker push-build-image-github || true # GitHub registry is experimental, it often fails so we ignore the errors

      - run: make -f Makefile.docker eksctl-image
      # TODO: push the image to Docker Hub

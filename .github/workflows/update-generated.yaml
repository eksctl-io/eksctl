name: Update generated files
on:
  workflow_dispatch: {}
  schedule:
  - cron: "0 5 * * Thu"

permissions:
  id-token: write

env:
  DEFAULT_BRANCH: main

jobs:
  update_generated_file:
    if: github.event.repository.fork == false
    strategy:
      fail-fast: false
      matrix:
        resource: ["coredns", "aws-node", "nvidia-device-plugin", "ec2-info"]
    name: Update ${{ matrix.resource }} and open PR
    runs-on: ubuntu-latest
    env:
      GOPRIVATE: ""
    steps:
    - name: Checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0
      with:
        token: ${{ secrets.EKSCTLBOT_TOKEN }}
        fetch-depth: 0
    - name: Configure AWS credentials for coredns update
      if: ${{ matrix.resource == 'coredns' }}
      uses: aws-actions/configure-aws-credentials@00943011d9042930efac3dcd3a170e4273319bc8 # v5.1.0
      with:
        aws-region: us-west-2
        role-duration-seconds: 900
        role-session-name: eksctl-update-coredns-assets
        role-to-assume: ${{ secrets.UPDATE_COREDNS_ROLE_ARN }}
    - name: Configure AWS credentials for ec2 info update
      if: ${{ matrix.resource == 'ec2-info' }}
      uses: aws-actions/configure-aws-credentials@00943011d9042930efac3dcd3a170e4273319bc8 # v5.1.0
      with:
        aws-region: us-west-2
        role-duration-seconds: 900
        role-session-name: eksctl-update-ec2-info-assets
        role-to-assume: ${{ secrets.UPDATE_EC2_INFO_ROLE_ARN }}
    - name: Setup identity as eksctl-bot
      uses: ./.github/actions/setup-identity
      with:
        token: "${{ secrets.EKSCTLBOT_TOKEN }}"
    - name: Setup build environment
      uses: ./.github/actions/setup-build
    - name: Update ${{ matrix.resource }}
      run: make update-${{ matrix.resource }}
    - name: Upsert pull request
      uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 #v8.1.0
      with:
        token: ${{ secrets.EKSCTLBOT_TOKEN }}
        commit-message: update ${{ matrix.resource }}${{ env.LATEST_RELEASE_TAG }}
        committer: eksctl-bot <eksctl-bot@users.noreply.github.com>
        title: 'Update ${{ matrix.resource }}${{ env.LATEST_RELEASE_TAG }}'
        branch: update-${{ matrix.resource }}
        labels: area/tech-debt
        body: |
          Auto-generated by [eksctl Update Generated Files GitHub workflow][1]

          [1]: https://github.com/eksctl-io/eksctl/blob/main/.github/workflows/update-generated.yaml

          Please manually test before approving and merging.

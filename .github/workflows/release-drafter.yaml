name: Draft Release Notes

on:
  push:
    # branches to consider in the event; optional, defaults to all
    branches:
      - main

permissions:
  contents: read

jobs:
  update_release_draft:
    if: github.event.repository.fork == false
    permissions:
      # write permission is required to create a github release
      contents: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      # Drafts your next Release notes as Pull Requests are merged into "master"
      - name: Draft release notes
        id: draft
        uses: release-drafter/release-drafter@b1476f6e6eb133afa41ed8589daba6dc69b4d3f5 #v6.1.0
        # (Optional) specify config name to use, relative to .github/. Default: release-drafter.yml
        # with:
        #   config-name: my-config.yml
        #   disable-autolabeler: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          commitish: main
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd #v6.0.2
      - name: Copy release notes from Draft
        run: |
          tag_name=${{ steps.draft.outputs.tag_name }}
          echo "${{ steps.draft.outputs.body }}" > docs/release_notes/${tag_name:1}.md
      - name: Upsert pull request
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e #v7.0.8
        with:
          token: ${{ secrets.EKSCTLBOT_TOKEN }}
          commit-message: Add release notes for ${{ steps.draft.outputs.tag_name }}
          committer: eksctl-bot <eksctl-bot@users.noreply.github.com>
          body: |
            ðŸ¤– Copy release notes from Draft

            <details>
            <summary> Full draft release notes for ${{ steps.draft.outputs.tag_name }} </summary>
            <blockquote>

            ${{ steps.draft.outputs.body }}

            </blockquote>
            </details>
            <br />

            Auto-generated by [eksctl Draft Release Notes GitHub workflow][1]

            [1]: https://github.com/eksctl-io/eksctl/blob/main/.github/workflows/release-drafter.yaml
          title: 'Add release notes for ${{ steps.draft.outputs.tag_name }}'
          labels: kind/improvement, skip-release-notes
          branch: update-release-notes

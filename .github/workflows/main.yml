name: ci

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
jobs:
  build:
    name: Build binaries on ${{ matrix.target_os }}_${{ matrix.target_arch }}
    runs-on: ${{ matrix.os }}
    container: weaveworks/eksctl-build:63bb98c9599ef0b0cc8bc08f64b6d572765e160e
    env:
      GOVER: 1.13.9
      GOOS: ${{ matrix.target_os }}
      GOARCH: ${{ matrix.target_arch }}
      GOPROXY: https://proxy.golang.org,direct
    strategy:
      matrix:
        #os: [ubuntu-latest, macOS-latest, windows-latest]
        os: [ubuntu-latest]
        target_arch: [amd64]
        include:
          - os: ubuntu-latest
            target_os: linux
#          - os: macOS-latest
#            target_os: darwin
#          - os: windows-latest
#            target_os: darwin
    steps:
      - name: Check out code into the Go module directory
        uses: actions/checkout@v2
      - name: Check all generated files
        run: make check-all-generated-files-up-to-date
      - name: Run make test
        run: make test
        env:
          JUNIT_REPORT_DIR: ${{ github.workspace }}/test-results
      - name: Run make build
        run: make build
      - name: Run make build integration test
        run: make build-integration-test
      - name: Upload test result artifact
        uses: actions/upload-artifact@v1
        with:
          name: test-results
          path: test-results
      - name: Upload eksctl artifact
        uses: actions/upload-artifact@v1
        with:
          name: eksctl
          path: eksctl
      - name: Upload eksctl-integration artifact
        uses: actions/upload-artifact@v1
        with:
          name: eksctl-integration-test
          path: eksctl-integration-test
